/**
 * Templates restants - Version simplifiee sans caracteres speciaux
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

const TEST_EMAIL = 'r.tardy@rt-groupe.com';
const REGION = 'eu-central-1';

console.log(`\n Envoi des templates restants...\n`);

const templates = [
  {
    name: '2. Dispatch - Nouvelle offre',
    fromEmail: 'noreply@symphonia-controltower.com',
    fromName: 'SYMPHONI.A',
    subject: '[SYMPHONI.A] Nouvelle offre de transport - Paris Lyon',
    html: `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body style="margin:0;padding:0;font-family:Segoe UI,Arial,sans-serif;background:#f4f7fa;"><table width="100%" cellpadding="0" cellspacing="0" style="padding:40px 20px;"><tr><td align="center"><table width="600" cellpadding="0" cellspacing="0" style="background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.08);"><tr><td style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:30px 40px;text-align:center;"><p style="color:rgba(255,255,255,0.9);margin:0 0 5px;font-size:12px;text-transform:uppercase;letter-spacing:1px;">Nouvelle opportunite</p><h1 style="color:#fff;margin:0;font-size:26px;font-weight:700;">Offre de Transport</h1></td></tr><tr><td style="padding:0;text-align:center;"><div style="display:inline-block;background:#10b981;color:#fff;padding:12px 30px;border-radius:0 0 12px 12px;font-size:18px;font-weight:700;">850 EUR HT</div></td></tr><tr><td style="padding:35px 40px;"><table width="100%" style="background:#f8fafc;border-radius:12px;padding:25px;margin-bottom:25px;"><tr><td width="45%" style="text-align:center;"><p style="color:#667eea;font-size:12px;text-transform:uppercase;margin:0 0 5px;font-weight:600;">Depart</p><p style="color:#1a1a2e;font-size:20px;font-weight:700;margin:0;">PARIS</p><p style="color:#718096;font-size:13px;margin:5px 0 0;">20 Jan. 2024 - 08h00</p></td><td width="10%" style="text-align:center;font-size:24px;">&#8594;</td><td width="45%" style="text-align:center;"><p style="color:#10b981;font-size:12px;text-transform:uppercase;margin:0 0 5px;font-weight:600;">Arrivee</p><p style="color:#1a1a2e;font-size:20px;font-weight:700;margin:0;">LYON</p><p style="color:#718096;font-size:13px;margin:5px 0 0;">20 Jan. 2024 - 14h00</p></td></tr></table><table width="100%" style="margin-bottom:25px;"><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Marchandise</span><span style="color:#1a1a2e;font-size:14px;font-weight:600;float:right;">12 palettes - 8,5 tonnes</span></td></tr><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Type</span><span style="color:#1a1a2e;font-size:14px;font-weight:600;float:right;">Bache / Tautliner</span></td></tr><tr><td style="padding:12px 0;"><span style="color:#718096;font-size:13px;">Reference</span><span style="color:#667eea;font-size:14px;font-weight:600;float:right;">ORD-2024-00142</span></td></tr></table><table width="100%"><tr><td width="48%" style="padding-right:2%;"><a href="#" style="display:block;background:#10b981;color:#fff;text-decoration:none;padding:16px;border-radius:10px;font-weight:600;font-size:15px;text-align:center;">Accepter</a></td><td width="48%" style="padding-left:2%;"><a href="#" style="display:block;background:#f1f5f9;color:#64748b;text-decoration:none;padding:16px;border-radius:10px;font-weight:600;font-size:15px;text-align:center;">Decliner</a></td></tr></table><p style="color:#f59e0b;font-size:13px;text-align:center;margin:20px 0 0;font-weight:500;">Cette offre expire dans 24 heures</p></td></tr><tr><td style="background:#f8f9ff;padding:20px 40px;text-align:center;"><p style="color:#a0aec0;margin:0;font-size:12px;">SYMPHONI.A - Plateforme logistique</p></td></tr></table></td></tr></table></body></html>`
  },
  {
    name: '4. Tracking - En livraison',
    fromEmail: 'noreply@symphonia-controltower.com',
    fromName: 'SYMPHONI.A',
    subject: '[SYMPHONI.A] Votre colis arrive bientot',
    html: `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body style="margin:0;padding:0;font-family:Segoe UI,Arial,sans-serif;background:#f4f7fa;"><table width="100%" cellpadding="0" cellspacing="0" style="padding:40px 20px;"><tr><td align="center"><table width="600" cellpadding="0" cellspacing="0" style="background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.08);"><tr><td style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);padding:35px 40px;text-align:center;"><h1 style="color:#fff;margin:0;font-size:24px;font-weight:700;">En cours de livraison</h1><p style="color:rgba(255,255,255,0.9);margin:10px 0 0;font-size:14px;">Votre commande est en route</p></td></tr><tr><td style="padding:35px 40px;"><table width="100%" style="margin-bottom:30px;"><tr><td><div style="background:#e2e8f0;height:6px;border-radius:3px;overflow:hidden;"><div style="background:linear-gradient(90deg,#10b981,#3b82f6);width:75%;height:100%;"></div></div></td></tr></table><table width="100%" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:12px;padding:20px;margin-bottom:25px;text-align:center;"><tr><td><p style="color:#92400e;font-size:12px;text-transform:uppercase;margin:0 0 5px;font-weight:600;">Arrivee estimee</p><p style="color:#78350f;font-size:28px;font-weight:700;margin:0;">Aujourd hui 15h30</p></td></tr></table><table width="100%" style="background:#f8fafc;border-radius:12px;padding:20px;margin-bottom:25px;"><tr><td width="45%"><p style="color:#64748b;font-size:11px;text-transform:uppercase;margin:0 0 3px;">Depart</p><p style="color:#1a1a2e;font-size:16px;font-weight:600;margin:0;">Paris (75)</p></td><td width="10%" style="text-align:center;color:#3b82f6;font-size:20px;">&#8594;</td><td width="45%" style="text-align:right;"><p style="color:#64748b;font-size:11px;text-transform:uppercase;margin:0 0 3px;">Destination</p><p style="color:#1a1a2e;font-size:16px;font-weight:600;margin:0;">Lyon (69)</p></td></tr></table><table width="100%" style="margin-bottom:25px;"><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Transporteur</span><span style="color:#1a1a2e;font-size:14px;font-weight:600;float:right;">Transport Express</span></td></tr><tr><td style="padding:12px 0;"><span style="color:#718096;font-size:13px;">Reference</span><span style="color:#667eea;font-size:14px;font-weight:600;float:right;">ORD-2024-00142</span></td></tr></table><table width="100%"><tr><td align="center"><a href="#" style="display:inline-block;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;text-decoration:none;padding:14px 35px;border-radius:50px;font-weight:600;font-size:14px;">Suivre en temps reel</a></td></tr></table></td></tr><tr><td style="background:#f8f9ff;padding:20px 40px;text-align:center;"><p style="color:#a0aec0;margin:0;font-size:12px;">SYMPHONI.A - Suivi de livraison</p></td></tr></table></td></tr></table></body></html>`
  },
  {
    name: '5. Portal - Invitation',
    fromEmail: 'noreply@symphonia-controltower.com',
    fromName: 'SYMPHONI.A',
    subject: '[SYMPHONI.A] Suivez votre livraison en direct',
    html: `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body style="margin:0;padding:0;font-family:Segoe UI,Arial,sans-serif;background:#f4f7fa;"><table width="100%" cellpadding="0" cellspacing="0" style="padding:40px 20px;"><tr><td align="center"><table width="600" cellpadding="0" cellspacing="0" style="background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.08);"><tr><td style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);padding:40px;text-align:center;"><h1 style="color:#fff;margin:0;font-size:26px;font-weight:700;">Portail Destinataire</h1><p style="color:rgba(255,255,255,0.9);margin:10px 0 0;font-size:14px;">Acces au suivi de livraison</p></td></tr><tr><td style="padding:35px 40px;"><h2 style="color:#1a1a2e;margin:0 0 20px;font-size:20px;font-weight:600;">Bonjour Jean Dupont,</h2><p style="color:#4a5568;line-height:1.7;margin:0 0 25px;font-size:15px;">Une livraison est prevue pour vous. Accedez a votre espace pour suivre votre colis.</p><table width="100%" style="background:#f5f3ff;border-radius:12px;padding:20px;margin-bottom:25px;text-align:center;"><tr><td><p style="color:#7c3aed;font-size:12px;text-transform:uppercase;margin:0 0 5px;font-weight:600;">Commande</p><p style="color:#1a1a2e;font-size:20px;font-weight:700;margin:0;">ORD-2024-00142</p></td></tr></table><h3 style="color:#1a1a2e;font-size:15px;margin:0 0 15px;font-weight:600;">Votre espace vous permet de :</h3><table width="100%" style="margin-bottom:25px;"><tr><td style="padding:10px 0;color:#4a5568;font-size:14px;">&#128205; Suivre la position du camion en temps reel</td></tr><tr><td style="padding:10px 0;color:#4a5568;font-size:14px;">&#9200; Voir l heure d arrivee estimee</td></tr><tr><td style="padding:10px 0;color:#4a5568;font-size:14px;">&#9997; Signer electroniquement le bon de livraison</td></tr><tr><td style="padding:10px 0;color:#4a5568;font-size:14px;">&#128196; Telecharger vos documents</td></tr></table><table width="100%"><tr><td align="center"><a href="#" style="display:inline-block;background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;text-decoration:none;padding:16px 40px;border-radius:50px;font-weight:600;font-size:15px;">Acceder a mon espace</a></td></tr></table><p style="color:#a0aec0;font-size:12px;text-align:center;margin:20px 0 0;">Ce lien est valable 7 jours</p></td></tr><tr><td style="background:#f8f9ff;padding:20px 40px;text-align:center;"><p style="color:#a0aec0;margin:0;font-size:12px;">SYMPHONI.A by RT Technologie</p></td></tr></table></td></tr></table></body></html>`
  },
  {
    name: '6. Incident - Alerte',
    fromEmail: 'noreply@symphonia-controltower.com',
    fromName: 'SYMPHONI.A',
    subject: '[SYMPHONI.A] Incident signale - ORD-2024-00142',
    html: `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body style="margin:0;padding:0;font-family:Segoe UI,Arial,sans-serif;background:#f4f7fa;"><table width="100%" cellpadding="0" cellspacing="0" style="padding:40px 20px;"><tr><td align="center"><table width="600" cellpadding="0" cellspacing="0" style="background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.08);"><tr><td style="background:linear-gradient(135deg,#ef4444,#dc2626);padding:35px 40px;text-align:center;"><div style="width:60px;height:60px;background:rgba(255,255,255,0.2);border-radius:50%;margin:0 auto 15px;line-height:60px;font-size:28px;">&#9888;</div><h1 style="color:#fff;margin:0;font-size:24px;font-weight:700;">Incident Signale</h1></td></tr><tr><td style="padding:0;text-align:center;"><div style="display:inline-block;background:#fef2f2;color:#dc2626;padding:8px 20px;border-radius:0 0 10px 10px;font-size:13px;font-weight:600;border:1px solid #fecaca;border-top:none;">Severite : MAJEUR</div></td></tr><tr><td style="padding:35px 40px;"><p style="color:#4a5568;line-height:1.7;margin:0 0 20px;font-size:15px;">Un incident a ete signale pour la commande <strong style="color:#1a1a2e;">ORD-2024-00142</strong>.</p><table width="100%" style="background:#fef2f2;border-radius:12px;border-left:4px solid #ef4444;padding:20px;margin-bottom:25px;"><tr><td><p style="color:#991b1b;font-weight:600;margin:0 0 10px;font-size:14px;">Type : Marchandise endommagee</p><p style="color:#7f1d1d;margin:0;font-size:14px;line-height:1.6;"><strong>Description :</strong><br>2 cartons presentent des traces d ecrasement.</p></td></tr></table><table width="100%" style="margin-bottom:25px;"><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Signale par</span><span style="color:#1a1a2e;font-size:14px;font-weight:600;float:right;">Pierre Durand</span></td></tr><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Date</span><span style="color:#1a1a2e;font-size:14px;font-weight:600;float:right;">15 Jan. 2024 a 14h45</span></td></tr><tr><td style="padding:12px 0;"><span style="color:#718096;font-size:13px;">Ref. incident</span><span style="color:#ef4444;font-size:14px;font-weight:600;float:right;">INC-2024-00089</span></td></tr></table><table width="100%"><tr><td align="center"><a href="#" style="display:inline-block;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;text-decoration:none;padding:14px 35px;border-radius:50px;font-weight:600;font-size:14px;">Gerer cet incident</a></td></tr></table></td></tr><tr><td style="background:#f8f9ff;padding:20px 40px;text-align:center;"><p style="color:#a0aec0;margin:0;font-size:12px;">SYMPHONI.A - Gestion des incidents</p></td></tr></table></td></tr></table></body></html>`
  },
  {
    name: '7. Document - CMR',
    fromEmail: 'noreply@symphonia-controltower.com',
    fromName: 'SYMPHONI.A',
    subject: '[SYMPHONI.A] Nouveau document - CMR disponible',
    html: `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body style="margin:0;padding:0;font-family:Segoe UI,Arial,sans-serif;background:#f4f7fa;"><table width="100%" cellpadding="0" cellspacing="0" style="padding:40px 20px;"><tr><td align="center"><table width="600" cellpadding="0" cellspacing="0" style="background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.08);"><tr><td style="background:linear-gradient(135deg,#667eea,#764ba2);padding:35px 40px;text-align:center;"><h1 style="color:#fff;margin:0;font-size:24px;font-weight:700;">Nouveau Document</h1><p style="color:rgba(255,255,255,0.9);margin:10px 0 0;font-size:14px;">Un document a ete ajoute</p></td></tr><tr><td style="padding:35px 40px;"><table width="100%" style="background:#f8fafc;border-radius:12px;padding:25px;margin-bottom:25px;text-align:center;"><tr><td><div style="width:70px;height:70px;background:#e0e7ff;border-radius:12px;margin:0 auto 15px;line-height:70px;font-size:32px;">&#128203;</div><p style="color:#667eea;font-size:12px;text-transform:uppercase;margin:0 0 5px;font-weight:600;">Document</p><p style="color:#1a1a2e;font-size:20px;font-weight:700;margin:0;">CMR - Lettre de voiture</p></td></tr></table><table width="100%" style="margin-bottom:25px;"><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Commande</span><span style="color:#667eea;font-size:14px;font-weight:600;float:right;">ORD-2024-00142</span></td></tr><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Depose par</span><span style="color:#1a1a2e;font-size:14px;font-weight:600;float:right;">Transport Express</span></td></tr><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Date</span><span style="color:#1a1a2e;font-size:14px;font-weight:600;float:right;">15 Jan. 2024 a 16h45</span></td></tr><tr><td style="padding:12px 0;"><span style="color:#718096;font-size:13px;">Statut</span><span style="color:#f59e0b;font-size:14px;font-weight:600;float:right;">En attente de validation</span></td></tr></table><table width="100%"><tr><td width="48%" style="padding-right:2%;"><a href="#" style="display:block;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;text-decoration:none;padding:14px;border-radius:10px;font-weight:600;font-size:14px;text-align:center;">Voir document</a></td><td width="48%" style="padding-left:2%;"><a href="#" style="display:block;background:#10b981;color:#fff;text-decoration:none;padding:14px;border-radius:10px;font-weight:600;font-size:14px;text-align:center;">Valider</a></td></tr></table></td></tr><tr><td style="background:#f8f9ff;padding:20px 40px;text-align:center;"><p style="color:#a0aec0;margin:0;font-size:12px;">SYMPHONI.A - Gestion documentaire</p></td></tr></table></td></tr></table></body></html>`
  },
  {
    name: '10. Closure - Cloture',
    fromEmail: 'noreply@symphonia-controltower.com',
    fromName: 'SYMPHONI.A',
    subject: '[SYMPHONI.A] Commande cloturee - ORD-2024-00142',
    html: `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body style="margin:0;padding:0;font-family:Segoe UI,Arial,sans-serif;background:#f4f7fa;"><table width="100%" cellpadding="0" cellspacing="0" style="padding:40px 20px;"><tr><td align="center"><table width="600" cellpadding="0" cellspacing="0" style="background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.08);"><tr><td style="background:linear-gradient(135deg,#10b981,#059669);padding:40px;text-align:center;"><div style="width:70px;height:70px;background:rgba(255,255,255,0.2);border-radius:50%;margin:0 auto 15px;line-height:70px;font-size:36px;">&#10003;</div><h1 style="color:#fff;margin:0;font-size:26px;font-weight:700;">Commande Cloturee</h1></td></tr><tr><td style="padding:35px 40px;"><table width="100%" style="background:#f0fdf4;border-radius:12px;padding:20px;margin-bottom:25px;text-align:center;"><tr><td><p style="color:#059669;font-size:12px;text-transform:uppercase;margin:0 0 5px;font-weight:600;">Reference</p><p style="color:#1a1a2e;font-size:22px;font-weight:700;margin:0;">ORD-2024-00142</p></td></tr></table><p style="color:#4a5568;line-height:1.7;margin:0 0 25px;font-size:15px;">Cette commande a ete cloturee avec succes. Tous les documents sont valides et archives.</p><table width="100%" style="margin-bottom:25px;"><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Trajet</span><span style="color:#1a1a2e;font-size:14px;font-weight:600;float:right;">Paris - Lyon</span></td></tr><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Transporteur</span><span style="color:#1a1a2e;font-size:14px;font-weight:600;float:right;">Transport Express</span></td></tr><tr><td style="padding:12px 0;border-bottom:1px solid #e8ecf4;"><span style="color:#718096;font-size:13px;">Livraison</span><span style="color:#10b981;font-size:14px;font-weight:600;float:right;">15 Jan. 2024</span></td></tr><tr><td style="padding:12px 0;"><span style="color:#718096;font-size:13px;">Documents</span><span style="color:#10b981;font-size:14px;font-weight:600;float:right;">CMR - POD valides</span></td></tr></table><table width="100%" style="background:#eff6ff;border-radius:10px;padding:15px 20px;margin-bottom:25px;"><tr><td><p style="color:#3b82f6;margin:0;font-size:13px;">Cette commande sera archivee dans 30 jours et conservee 10 ans.</p></td></tr></table><table width="100%"><tr><td align="center"><a href="#" style="display:inline-block;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;text-decoration:none;padding:14px 35px;border-radius:50px;font-weight:600;font-size:14px;">Acceder aux documents</a></td></tr></table></td></tr><tr><td style="background:#f8f9ff;padding:20px 40px;text-align:center;"><p style="color:#a0aec0;margin:0;font-size:12px;">SYMPHONI.A by RT Technologie</p></td></tr></table></td></tr></table></body></html>`
  }
];

function sendEmail(template, index) {
  const messageJson = {
    Subject: { Data: template.subject, Charset: 'UTF-8' },
    Body: { Html: { Data: template.html, Charset: 'UTF-8' } }
  };

  const tempFile = path.join(__dirname, `temp-rem-${index}.json`);
  fs.writeFileSync(tempFile, JSON.stringify(messageJson));

  const destJson = { ToAddresses: [TEST_EMAIL] };
  const destFile = path.join(__dirname, `temp-dest-rem-${index}.json`);
  fs.writeFileSync(destFile, JSON.stringify(destJson));

  const fromAddress = `${template.fromName} <${template.fromEmail}>`;
  const cmd = `aws ses send-email --region ${REGION} --from "${fromAddress}" --destination file://${destFile} --message file://${tempFile}`;

  try {
    execSync(cmd, { encoding: 'utf8', stdio: ['pipe', 'pipe', 'pipe'] });
    console.log(`OK ${template.name}`);
    fs.unlinkSync(tempFile);
    fs.unlinkSync(destFile);
    return true;
  } catch (error) {
    try { fs.unlinkSync(tempFile); } catch(e) {}
    try { fs.unlinkSync(destFile); } catch(e) {}
    console.error(`FAIL ${template.name}`);
    return false;
  }
}

async function run() {
  let success = 0;
  for (let i = 0; i < templates.length; i++) {
    if (sendEmail(templates[i], i)) success++;
    await new Promise(r => setTimeout(r, 400));
  }
  console.log(`\nResultat: ${success}/${templates.length} envoyes`);
}

run();
